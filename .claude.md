# Claude Context - QuantSage Trading System

> **For Claude Code / AI Assistants picking up this project**

## Project Summary

**QuantSage** is a production-ready quantitative trading system for cryptocurrencies and stocks. We're building it from scratch to replace a flawed "CryptoSage" system that had SQL injection vulnerabilities, data leakage in ML models, no risk management, and no backtesting.

**Current Status:** Week 1 Complete âœ… - Core infrastructure is solid
**Next Step:** Week 2 - Data collection and feature engineering

---

## Quick Start for Claude

### If user says "continue building" or "what's next":

1. **Check progress:** Read `/docs/PROGRESS.md` for current status
2. **Next tasks:** Week 2 tasks in `/docs/PROJECT_PLAN.md`
3. **Priority:** Data collectors â†’ Feature engineering â†’ Validators

### If user says "explain the architecture":

Read `/docs/ARCHITECTURE.md` - comprehensive system design documentation

### If user says "run tests":

```bash
cd /Users/jkgurung/workspace/quantsage
python scripts/test_foundation.py
```

Expected: All tests should pass âœ…

---

## Project Location

**Main Directory:** `/Users/jkgurung/workspace/quantsage/`

**Old System (reference only):** `/Users/jkgurung/workspace/cryptosage/`
- Don't modify the old system
- Can reference for data collection code
- Has SQL injection issues (DON'T copy those patterns)

---

## What's Built (Week 1 - Complete)

### âœ… Core Infrastructure

1. **Database Layer** (`src/data/`)
   - Schema: 8 tables for market data, positions, orders, trades, signals, etc.
   - Storage: Secure database manager with **parameterized queries** (fixes SQL injection)
   - File: `src/data/storage.py` - All CRUD operations

2. **Event System** (`src/core/`)
   - Events: 7 types (MarketData, Signal, Order, Fill, PositionUpdate, RiskAlert, etc.)
   - Event Bus: Pub/sub pattern for component communication
   - Files: `src/core/events.py`, `src/core/event_bus.py`

3. **Configuration** (`config/`, `src/core/`)
   - YAML-based: No magic numbers in code
   - Files: `config/config.yaml`, `config/risk.yaml`, `config/strategies/*.yaml`
   - Manager: `src/core/config.py` - OmegaConf-based

4. **Tests** (`scripts/`)
   - Foundation tests: `scripts/test_foundation.py`
   - Status: All passing âœ…

### ðŸ“ Key Files

| File | Purpose | Status |
|------|---------|--------|
| `src/data/schema.sql` | Database schema | âœ… Complete |
| `src/data/storage.py` | Secure DB operations | âœ… Complete |
| `src/core/events.py` | Event classes | âœ… Complete |
| `src/core/event_bus.py` | Event distribution | âœ… Complete |
| `src/core/config.py` | Configuration manager | âœ… Complete |
| `config/config.yaml` | Main config | âœ… Complete |
| `config/risk.yaml` | Risk parameters | âœ… Complete |

---

## What Needs Building (Week 2-8)

### Week 2: Data Collection & Validation (NEXT)

**Priority 1:**
- [ ] `src/data/collectors/crypto_collector.py` - CCXT wrapper for exchanges
  - Salvage from: `/Users/jkgurung/workspace/cryptosage/src/data_collector.py`
  - Add: Rate limiting, retry logic, CCXT integration
  - Fix: Use parameterized queries

**Priority 2:**
- [ ] `src/data/validators.py` - Data quality checks
  - Validate price consistency
  - Detect outliers
  - Handle gaps

**Priority 3:**
- [ ] `src/data/features.py` - Feature engineering
  - **CRITICAL:** Fix data leakage from old system
  - Proper train/test split
  - Salvage from: `/Users/jkgurung/workspace/cryptosage/src/feature_engineering.py`

### Week 3-4: Strategy Framework & Risk

- [ ] `src/strategies/base.py` - Abstract strategy class
- [ ] `src/strategies/mean_reversion.py` - Bollinger Bands strategy
- [ ] `src/portfolio/risk.py` - Multi-layer risk management

### Week 5: Backtesting

- [ ] `src/backtesting/engine.py` - Event-driven backtest
- [ ] `src/backtesting/metrics.py` - Performance calculations

### Week 6-8: Portfolio, Execution, Monitoring

See `/docs/PROJECT_PLAN.md` for details

---

## Architecture Overview

### Event-Driven Design

**Key Principle:** Same code runs in backtest and live modes

```
Data â†’ MarketDataEvent â†’ Strategies â†’ SignalEvent â†’ Portfolio â†’ OrderEvent
â†’ Risk Check â†’ Execution â†’ FillEvent â†’ Portfolio Update
```

### Component Communication

**All via Event Bus:**
- Components publish events
- Components subscribe to events
- No direct dependencies
- Easy to test in isolation

### Configuration-Driven

**No Magic Numbers:**
- All parameters in YAML
- Easy to test different configs
- Version control parameters

---

## Critical Issues Fixed from Old System

| Issue | Old CryptoSage | New QuantSage |
|-------|---------------|---------------|
| **SQL Injection** | âŒ f-strings in queries | âœ… Parameterized queries |
| **Data Leakage** | âŒ Normalization uses entire dataset | âœ… Proper train/test split |
| **LSTM Bug** | âŒ Trained as regression, used as classification | âœ… Using XGBoost classifier |
| **No Risk Mgmt** | âŒ No position limits | âœ… 4-layer risk system |
| **No Backtesting** | âŒ Can't validate strategies | âœ… Event-driven backtest engine |
| **Magic Numbers** | âŒ Hardcoded everywhere | âœ… YAML configuration |

---

## Common User Requests & Responses

### "Continue building" / "What's next?"

**Response:**
1. Update todo list
2. Start with Week 2, Priority 1: `src/data/collectors/crypto_collector.py`
3. Reference old system: `/Users/jkgurung/workspace/cryptosage/src/data_collector.py`
4. But fix the issues (parameterized queries, better error handling)

### "Run tests"

**Command:**
```bash
python scripts/test_foundation.py
```

**Expected:** All tests pass âœ…

**If fails:** Check which test failed, fix the issue

### "Show me what we built"

**Response:**
1. Show `/docs/PROGRESS.md` summary
2. Explain event-driven architecture
3. Demonstrate with test script

### "I want to add [new feature]"

**Response:**
1. Check if it fits current week's plan
2. If yes: Implement with tests
3. If no: Add to backlog, finish current week first

### "Explain [component]"

**Response:**
1. Check `/docs/ARCHITECTURE.md` for detailed explanation
2. Show relevant code files
3. Explain with examples

---

## Development Guidelines

### When Writing Code

**Always:**
- âœ… Use parameterized queries for database
- âœ… Add type hints
- âœ… Write docstrings
- âœ… Handle errors gracefully
- âœ… Log important events
- âœ… Write tests

**Never:**
- âŒ Hardcode values (use config)
- âŒ Use f-strings in SQL queries
- âŒ Silently fail (log errors)
- âŒ Fit scaler on entire dataset (data leakage)
- âŒ Skip validation

### Code Style

```python
# Good
query = "SELECT * FROM market_data WHERE symbol = ?"
cursor.execute(query, (symbol,))

# Bad - SQL injection risk!
query = f"SELECT * FROM market_data WHERE symbol = '{symbol}'"
cursor.execute(query)
```

```python
# Good - No data leakage
scaler = StandardScaler()
X_train_scaled = scaler.fit_transform(X_train)
X_test_scaled = scaler.transform(X_test)  # Use fitted scaler

# Bad - Data leakage!
scaler = StandardScaler()
X_scaled = scaler.fit_transform(X_all)  # Future data leaks into past!
```

### Testing Approach

**Always test after implementing:**
```bash
# Run specific test
pytest tests/unit/test_[component].py

# Run all tests
pytest tests/

# Run foundation tests
python scripts/test_foundation.py
```

---

## File Organization

```
quantsage/
â”œâ”€â”€ config/              # YAML configurations
â”‚   â”œâ”€â”€ config.yaml     # Main config
â”‚   â”œâ”€â”€ risk.yaml       # Risk parameters
â”‚   â””â”€â”€ strategies/     # Strategy configs
â”‚
â”œâ”€â”€ src/                # Source code
â”‚   â”œâ”€â”€ core/          # Event system, config
â”‚   â”œâ”€â”€ data/          # Data collection, storage
â”‚   â”œâ”€â”€ strategies/    # Trading strategies
â”‚   â”œâ”€â”€ backtesting/   # Backtest engine
â”‚   â”œâ”€â”€ portfolio/     # Portfolio & risk mgmt
â”‚   â”œâ”€â”€ execution/     # Order execution
â”‚   â””â”€â”€ monitoring/    # Dashboard, alerts
â”‚
â”œâ”€â”€ scripts/           # Utility scripts
â”‚   â””â”€â”€ test_foundation.py  # Foundation tests
â”‚
â”œâ”€â”€ tests/             # Test files
â”‚   â”œâ”€â”€ unit/
â”‚   â””â”€â”€ integration/
â”‚
â”œâ”€â”€ docs/              # Documentation
â”‚   â”œâ”€â”€ PROGRESS.md         # Current status
â”‚   â”œâ”€â”€ PROJECT_PLAN.md     # Complete plan
â”‚   â”œâ”€â”€ ARCHITECTURE.md     # System design
â”‚   â””â”€â”€ .claude.md          # This file
â”‚
â”œâ”€â”€ data/              # Database files
â”œâ”€â”€ logs/              # Log files
â”œâ”€â”€ models/            # Trained models
â””â”€â”€ results/           # Backtest results
```

---

## Dependencies

**Installed:**
- pandas, numpy - Data manipulation
- omegaconf, python-dotenv, pyyaml - Configuration
- SQLite3 - Database (built-in)

**To Install (Week 2+):**
- ccxt - Crypto exchange API
- ta - Technical analysis
- scikit-learn, xgboost - Machine learning
- plotly, dash - Visualization

**Install when needed:**
```bash
pip install -r requirements.txt
```

---

## Environment Setup

**Current Setup:**
- Virtual environment: `/Users/jkgurung/workspace/cryptosage/venv/` (reusing from old project)
- Python: 3.9+
- Database: SQLite at `data/quantsage.db`

**Environment Variables:**
- File: `.env` (exists, has placeholders)
- Template: `.env.example`
- Currently: Using placeholder values for testing
- Real keys: User will provide when ready for live data

---

## Important Context

### User's Background
- Quant trader background
- Wants production-ready system
- Focus: Crypto initially, stocks later
- Approach: Backtest â†’ Paper trade â†’ Live (very cautious)
- Timeline: 6-8 weeks, 10-20 hours/week

### User's Goals
1. **Learn** quantitative trading system architecture
2. **Validate** strategies before any live trading
3. **Build** something that could potentially trade live
4. **Avoid** mistakes from old system

### User's Preferences
- âœ… Clean architecture over quick hacks
- âœ… Comprehensive documentation
- âœ… Test everything before deploying
- âœ… Start simple, add complexity gradually
- âŒ No live trading without extensive validation

---

## When User is Blocked

### "Not sure what to do next"
â†’ Check `/docs/PROJECT_PLAN.md`, Week 2 tasks

### "Something is broken"
â†’ Run `python scripts/test_foundation.py` to verify foundation
â†’ Check logs in `logs/` directory
â†’ Review recent changes

### "Need to understand [concept]"
â†’ Check `/docs/ARCHITECTURE.md` for system design
â†’ Check `/docs/PROJECT_PLAN.md` for component details
â†’ Look at test files for usage examples

### "Want to change direction"
â†’ Update todo list with new priorities
â†’ Document decision in `/docs/PROGRESS.md`
â†’ Ensure foundation stays solid

---

## Todo List Tracking

**Current Todo List:**
- [x] Create QuantSage project structure
- [x] Create SQLite database schema
- [x] Fix SQL injection with parameterized queries
- [x] Implement event system
- [x] Create configuration management
- [ ] Fix feature engineering data leakage
- [ ] Enhance data_collector with CCXT wrapper
- [ ] Implement data validators
- [ ] Implement BaseStrategy abstract class
- [ ] Implement MeanReversionStrategy
- [ ] Implement RiskManager
- [ ] Implement BacktestEngine
- [ ] Run backtest validation

**Use TodoWrite tool to track progress!**

---

## Quick Commands Reference

```bash
# Navigate to project
cd /Users/jkgurung/workspace/quantsage

# Activate virtual environment
source /Users/jkgurung/workspace/cryptosage/venv/bin/activate

# Run foundation tests
python scripts/test_foundation.py

# Install dependencies
pip install [package-name]

# View database
sqlite3 data/quantsage.db
.tables
.schema market_data
.exit
```

---

## Red Flags to Watch For

### ðŸš¨ Security Issues
- SQL f-strings â†’ Use parameterized queries
- Hardcoded API keys â†’ Use environment variables
- Logging sensitive data â†’ Sanitize logs

### ðŸš¨ Data Science Issues
- Fitting scaler on entire dataset â†’ Split train/test first
- Look-ahead bias in backtesting â†’ Ensure no future data
- Overfitting â†’ Cross-validation, walk-forward testing

### ðŸš¨ Architecture Issues
- Direct component dependencies â†’ Use event bus
- Magic numbers â†’ Move to config
- Ignoring errors â†’ Log and handle properly

---

## Success Metrics

### Week 1 âœ…
- All foundation tests passing
- Database secure (parameterized queries)
- Event system working
- Configuration loading correctly

### Week 2 (Target)
- Can fetch historical crypto data
- Data passes validation
- Feature engineering works without leakage
- Integration tests pass

### Final Success (Week 8)
- Backtest shows Sharpe > 1.5
- Max drawdown < -15%
- Risk controls prevent large losses
- System runs stable in paper trading
- Ready for small capital live test

---

## Helpful Reminders

1. **Foundation is solid** - Week 1 complete, tests passing âœ…
2. **Old system has issues** - Don't blindly copy code patterns
3. **Event-driven is key** - Same code for backtest and live
4. **Risk first** - Capital preservation > quick profits
5. **Test everything** - No deployment without validation

---

**Last Updated:** 2026-01-04
**For:** Claude Code / AI Assistants
**Project:** QuantSage Multi-Asset Trading System
**Status:** Week 1 Complete, Ready for Week 2
